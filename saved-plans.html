<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Meal Deal - Saved Plans</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- navigation bar at top -->
    <div class="navbar">
        <div class="navbar-content">
            <span class="logo-small">The Meal Deal</span>
            <div class="nav-links">
                <a href="preferences.html">← New Plan</a>
                <a href="index.html" class="btn-logout">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="saved-plans-box">
            <h1>Your Saved Meal Plans</h1>
            
            <!-- this div will hold all the saved meal plan cards -->
            <div id="plansList" class="plans-list">
                <!-- saved plans will be displayed here -->
            </div>

            <!-- this shows when user has no saved plans yet -->
            <div id="noPlans" class="empty-state">
                <p>No saved meal plans yet.</p>
                <a href="preferences.html" class="btn btn-primary">Create One Now</a>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script type="module">
        // import firebase auth and firestore database
        import { auth, db } from "./firebase.js";

        import {
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

        import {
            collection,
            query,
            where,
            getDocs,
            deleteDoc,
            doc
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // variable to store current logged in user
        let firebaseUser = null;

        // check if user is logged in when page loads
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // user not logged in so redirect to login page
                window.location.href = "index.html";
                return;
            }
            // save user info and load their saved plans
            firebaseUser = user;
            loadSavedPlans();
        });

        // logout button functionality
        const logoutButtons = document.querySelectorAll(".btn-logout");
        logoutButtons.forEach(btn => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                await signOut(auth);
                window.location.href = "index.html";
            });
        });


        // function to load and display all saved meal plans from firestore
        async function loadSavedPlans() {
            const plansList = document.getElementById("plansList");
            const noPlans = document.getElementById("noPlans");

            // clear existing content
            plansList.innerHTML = "";
            noPlans.style.display = "none";

            try {
                // create query to get only this user's meal plans
                const q = query(
                    collection(db, "mealPlans"),
                    where("userId", "==", firebaseUser.uid)
                );

                // get all matching documents from firestore
                const snapshot = await getDocs(q);

                // if user has no saved plans, show empty state message
                if (snapshot.empty) {
                    plansList.style.display = "none";
                    noPlans.style.display = "block";
                    return;
                }

                // loop through each saved plan and create a card for it
                snapshot.forEach(docSnapshot => {
                    const plan = docSnapshot.data();
                    const planId = docSnapshot.id;

                    // create html for plan card showing diet info and sample meals
                    const planCard = document.createElement('div');
                    planCard.className = 'plan-card';
                    planCard.innerHTML = `
                        <div class="plan-header">
                            <div>
                                <strong>Saved on ${new Date(plan.createdAt).toLocaleDateString()}</strong>
                                <p>${plan.diet} • Allergies: ${plan.allergies.length > 0 ? plan.allergies.join(', ') : 'None'}</p>
                            </div>
                            <button class="btn btn-danger btn-small" data-id="${planId}">Delete</button>
                        </div>
                        <div class="plan-preview">
                            <strong>Monday:</strong> 
                            ${plan.mealsData.Monday.breakfast.name}, 
                            ${plan.mealsData.Monday.lunch.name}, 
                            ${plan.mealsData.Monday.dinner.name}
                        </div>
                    `;

                    plansList.appendChild(planCard);
                });

                // show the plans list now that it has content
                plansList.style.display = "block";

                // add click handlers to all delete buttons
                attachDeleteButtons();

            } catch (err) {
                console.error("Error loading plans:", err);
            }
        }

        // function to add delete functionality to all delete buttons
        function attachDeleteButtons() {
            document.querySelectorAll(".btn-danger").forEach(btn => {
                btn.addEventListener("click", async () => {
                    // get plan id from the button's data attribute
                    const planId = btn.getAttribute("data-id");

                    // confirm user wants to delete
                    if (!confirm("Are you sure you want to delete this plan?")) return;

                    try {
                        // delete the plan from firestore
                        await deleteDoc(doc(db, "mealPlans", planId));
                        // reload the plans list to reflect the deletion
                        loadSavedPlans();
                    } catch (error) {
                        alert("Error deleting plan: " + error.message);
                    }
                });
            });
        }
    </script>
</body>
</html>